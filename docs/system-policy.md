# IT 자산 & 라이센스 관리 시스템 - 정책 정의서

> **Version**: 1.0  
> **Date**: 2026-02-20  

---

## 1. 공통 데이터 정책

### 1.1 기본 컬럼 규칙
모든 테이블에 아래 5개 컬럼을 기본 포함한다.

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| reg_date | TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP | 등록일시 |
| reg_id | BIGINT | 등록자 ID (member.member_id FK) |
| upd_date | TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP | 수정일시 |
| upd_id | BIGINT | 수정자 ID (member.member_id FK) |
| is_deleted | BOOLEAN NOT NULL DEFAULT false | 삭제 여부 (소프트 삭제) |

> **예외**: 이력(history) 테이블은 INSERT-ONLY 성격이므로 `upd_date`, `upd_id`, `is_deleted`를 제외하고 `reg_date`, `reg_id`만 포함한다.

### 1.2 소프트 삭제 정책
- 모든 데이터는 **물리 삭제하지 않고** `is_deleted = true`로 처리한다.
- 목록 조회 시 기본적으로 `is_deleted = false` 조건을 적용한다.
- 물리 삭제는 데이터 보존 기간 경과 후 **배치 작업**으로만 수행한다.
- 삭제 시 `is_deleted = true`, `upd_date = NOW()`, `upd_id = 처리자`를 함께 업데이트한다.

### 1.3 데이터 보존 기간
| 데이터 구분 | 보존 기간 | 비고 |
|-------------|----------|------|
| 자산 배정 이력 | 영구 | 감사 추적 목적 |
| 라이센스 배정 이력 | 영구 | 감사 추적 목적 |
| 소프트 삭제된 자산 | 3년 | 3년 후 물리 삭제 가능 |
| 소프트 삭제된 사용자 | 3년 | 퇴사 후 3년 |
| 소프트 삭제된 라이센스 | 3년 | 만료/폐기 후 3년 |
| 로그인 이력 | 1년 | 보안 감사용 |

### 1.4 코드 관리 정책
- 상태값, 유형값 등은 **common_code 테이블**로 일원화 관리한다.
- 코드 삭제는 불가하며, `is_active = false`로 비활성화만 가능하다.
- 이미 사용 중인 코드는 비활성화할 수 없다 (참조 무결성).

---

## 2. 인증/권한 정책

### 2.1 비밀번호 정책
| 항목 | 규칙 |
|------|------|
| 최소 길이 | 8자 이상 |
| 복잡도 | 영문 대소문자 + 숫자 + 특수문자 중 3종 이상 조합 |
| 만료 주기 | 90일 (만료 시 로그인 시 변경 강제) |
| 이전 비밀번호 재사용 | 최근 3개 비밀번호 재사용 불가 |
| 초기 비밀번호 | 관리자 등록 시 임시 비밀번호 발급, 최초 로그인 시 변경 강제 |
| 연속 실패 잠금 | 5회 연속 실패 시 계정 잠금 (관리자 해제 또는 30분 후 자동 해제) |

### 2.2 세션/토큰 정책
| 항목 | 값 | 비고 |
|------|-----|------|
| Access Token 유효기간 | 1시간 | JWT |
| Refresh Token 유효기간 | 24시간 | Redis 저장 |
| 동시 로그인 | 허용 (최대 3개 디바이스) | 초과 시 가장 오래된 세션 만료 |
| 세션 저장소 | Redis | 서버 재시작 시에도 유지 |

### 2.3 권한 체계
| 역할 | 코드 | 권한 범위 |
|------|------|----------|
| 시스템관리자 | ROLE_ADMIN | 전체 CRUD + 시스템 설정 |
| 자산관리자 | ROLE_ASSET_MANAGER | 자산/라이센스 CRUD + 사용자 조회 |
| 일반사용자 | ROLE_USER | 자신의 배정 현황 조회만 가능 |

- 사용자 1명에 **복수 권한** 부여 가능하다.
- 메뉴별로 Read/Create/Update/Delete 권한을 개별 제어한다.
- 권한이 없는 메뉴는 **화면에 노출되지 않는다**.
- API 호출 시 권한 검증 실패 시 **403 Forbidden**을 반환한다.

---

## 3. 부서 관리 정책

### 3.1 트리 구조 규칙
- 최상위 부서는 `parent_dept_id = NULL`이다.
- 부서 깊이(depth)는 **최대 5단계**까지 허용한다.
- 부서 이동 시 하위 부서의 `dept_depth`, `dept_path`를 **자동 재계산**한다.
- Materialized Path(`dept_path`)를 사용하여 하위 부서 조회 성능을 보장한다.

### 3.2 부서 삭제/비활성화 정책
- 하위 부서가 존재하는 부서는 **삭제할 수 없다** (하위 부서 먼저 이동 또는 삭제 필요).
- 소속 사용자가 있는 부서는 **삭제할 수 없다** (사용자 부서 이동 먼저 필요).
- 삭제는 `is_deleted = true`로 소프트 삭제한다.
- 비활성화(`is_active = false`)된 부서는 신규 사용자 배치가 불가하나, 기존 소속 사용자는 유지된다.

### 3.3 조직개편 처리
- 부서명 변경: `dept_name` 업데이트만 수행, 기존 데이터에 영향 없음.
- 부서 통폐합: 기존 부서 비활성화 + 소속 사용자를 신규 부서로 일괄 이동.
- 부서 분리: 신규 부서 생성 + 대상 사용자를 개별 이동.
- **자산/라이센스 배정은 사용자 ID 기준이므로 부서 변경의 영향을 받지 않는다.**

---

## 4. 사용자 관리 정책

### 4.1 사용자 등록 규칙
- `login_id`는 **영문 소문자 + 숫자 + 점(.)** 조합만 허용하며, 시스템 전체에서 유일해야 한다.
- 퇴사 후 삭제된 계정의 `login_id`는 **재사용할 수 없다**.
- 필수 입력: 사용자명, 로그인 ID, 부서, 직급, 입사일, 근무지.
- 선택 입력: 담당업무, 이메일, 연락처.

### 4.2 재직 상태 전이 규칙
```
[신규등록] → ACTIVE(재직)
ACTIVE(재직) → LEAVE(휴직)
ACTIVE(재직) → RESIGNED(퇴사)
LEAVE(휴직) → ACTIVE(재직)    -- 복직
LEAVE(휴직) → RESIGNED(퇴사)
```
- 위 전이 외의 상태 변경은 **허용하지 않는다**.
- RESIGNED(퇴사) 상태에서 다른 상태로 전이할 수 없다.

### 4.3 퇴사 처리 정책
퇴사 처리 시 아래 항목을 **순서대로** 처리한다.
1. `resign_date` 기록
2. `employment_status`를 RESIGNED으로 변경
3. 배정된 **모든 자산 자동 반납** 처리 (배정 상태 RETURNED, 자산 상태 AVAILABLE)
4. 배정된 **모든 라이센스 자동 회수** 처리 (배정 상태 RETURNED, used_qty 감소)
5. 각 회수 건에 대해 **이력 자동 기록** (action_type = 'RETURN', remarks = '퇴사로 인한 자동 회수')
6. 사용자 계정 비활성화 (`is_active = false`)
7. Redis 세션 삭제 (즉시 로그아웃)

### 4.4 휴직 처리 정책
- 자산/라이센스 **자동 회수하지 않는다** (회사별 정책에 따라 수동 처리).
- 계정은 비활성화하지 않으나, 로그인은 **차단**한다.

---

## 5. 자산 관리 정책

### 5.1 자산 상태 전이 규칙
```
[신규등록] → AVAILABLE(사용가능)
AVAILABLE(사용가능) → IN_USE(사용중)       -- 배정 시
AVAILABLE(사용가능) → REPAIR(수리중)       -- 수리 접수 시
AVAILABLE(사용가능) → DISPOSED(폐기)       -- 폐기 처리 시
IN_USE(사용중) → AVAILABLE(사용가능)       -- 반납 시
IN_USE(사용중) → REPAIR(수리중)            -- 사용중 고장
REPAIR(수리중) → AVAILABLE(사용가능)       -- 수리 완료
REPAIR(수리중) → DISPOSED(폐기)            -- 수리불가 폐기
DISPOSED(폐기) → (종료, 전이 불가)
AVAILABLE/IN_USE/REPAIR → LOST(분실)       -- 분실 신고
LOST(분실) → AVAILABLE(사용가능)           -- 발견 시
```
- 위 전이 외의 상태 변경은 **허용하지 않는다**.
- DISPOSED(폐기) 상태에서 다른 상태로 전이할 수 없다 (단, 오입력 시 관리자 정정 가능).

### 5.2 자산 배정 규칙
- 하나의 자산은 **동시에 1명에게만** 배정 가능하다 (DB UNIQUE INDEX 보장).
- AVAILABLE 상태인 자산만 배정할 수 있다.
- 배정 시: 자산 상태 → IN_USE, 배정 레코드 INSERT, 이력 INSERT.
- 반납 시: 자산 상태 → AVAILABLE, 배정 상태 → RETURNED, return_date 기록, 이력 INSERT.
- 이관 시: 기존 배정 반납 처리 + 신규 사용자에게 배정 처리를 **하나의 트랜잭션**으로 수행.

### 5.3 시리얼번호 관리
- 시리얼번호는 시스템 전체에서 **유일**해야 한다 (UNIQUE 제약).
- NULL 허용 (시리얼번호 없는 자산 존재 가능).
- 한번 등록된 시리얼번호는 다른 자산으로 변경할 수 없다 (수정 불가, 오입력 시 관리자 정정만 가능).

### 5.4 자산 삭제 정책
- 현재 배정 중(IN_USE)인 자산은 **삭제할 수 없다** (반납 먼저 필요).
- 삭제는 `is_deleted = true`로 소프트 삭제한다.
- 삭제된 자산의 배정 이력은 영구 보존된다.

---

## 6. 라이센스 관리 정책

### 6.1 라이센스 유형별 규칙

| 유형 | 코드 | 키 관리 | 수량 관리 | 만료일 |
|------|------|---------|----------|--------|
| 볼륨 | VOLUME | 1개 키를 N명 공유 가능 | total_qty로 인원 제한 | 선택 |
| 개별 | INDIVIDUAL | 1개 키 = 1명 전용 | 키 수량 = 배정 가능 수량 | 선택 |
| 구독 | SUBSCRIPTION | 유형에 따라 볼륨/개별 | total_qty로 인원 제한 | **필수** |

### 6.2 수량 관리 정책 (핵심)
- 배정 시 **반드시** `used_qty < total_qty` 검증 후 배정한다.
- 검증과 배정은 **하나의 트랜잭션 + Redis 분산락** 내에서 수행한다.
- 동시 요청 시 Redis 분산락(`SETNX`)으로 순차 처리를 보장한다.
- 락 획득 실패 시 최대 **3회 재시도** (100ms 간격), 실패 시 `409 Conflict` 반환.
- DB 트리거로 `used_qty` 자동 증감하며, CHECK 제약으로 음수/초과 방지.
- 매일 01:00 배치로 `v_license_qty_check` 뷰를 이용해 정합성 검증, 불일치 시 알림 + 자동 보정.

### 6.3 라이센스 키 상태 전이
```
[신규등록] → AVAILABLE(사용가능)
AVAILABLE(사용가능) → IN_USE(사용중)     -- 배정 시
IN_USE(사용중) → AVAILABLE(사용가능)     -- 회수 시
AVAILABLE/IN_USE → EXPIRED(만료)         -- 만료일 도래
AVAILABLE/IN_USE → REVOKED(폐기)         -- 관리자 폐기
```

### 6.4 라이센스 배정 규칙
- 동일 사용자에게 **동일 라이센스를 중복 배정할 수 없다** (이미 ASSIGNED 상태인 건이 있으면 거부).
- INDIVIDUAL 유형 배정 시 `key_id`는 **필수**이며, 해당 키가 AVAILABLE이어야 한다.
- VOLUME 유형은 `key_id`가 NULL 가능하다 (키 공유).
- SUBSCRIPTION 유형은 배정 시 `expiry_date`를 확인하여 만료된 라이센스는 배정 불가.
- 배정 사유(`assignment_reason`)는 **필수 입력**이다.

### 6.5 구독 만료 처리 정책
- 매일 00:00 배치로 `expiry_date`가 경과한 SUBSCRIPTION 라이센스를 검출한다.
- 만료 7일 전: 관리자에게 **만료 예정 알림**.
- 만료일 도래: 해당 라이센스의 모든 배정을 EXPIRED로 일괄 변경, `used_qty = 0`, 키 상태 EXPIRED.
- 이력에 action_type = 'EXPIRE'로 자동 기록.

### 6.6 라이센스 삭제 정책
- 현재 배정 중(ASSIGNED)인 라이센스는 **삭제할 수 없다** (회수 먼저 필요).
- 삭제는 `is_active = false`로 비활성화한다.
- 비활성화된 라이센스는 신규 배정이 불가하나, 기존 배정 이력은 유지된다.

---

## 7. 향후 확장 정책 (이메일 발송)

### 7.1 이메일 발송 트리거
| 이벤트 | 수신자 | 내용 |
|--------|--------|------|
| 라이센스 배정 | 배정 대상 사용자 | 라이센스 키 + 설치 가이드 (`install_guide` 컬럼) |
| 라이센스 만료 7일 전 | 관리자 + 사용자 | 만료 예정 안내 |
| 라이센스 만료 | 관리자 | 자동 회수 처리 완료 보고 |
| 자산 배정 | 배정 대상 사용자 | 배정 자산 정보 안내 |
| 수량 정합성 불일치 | 관리자 | 불일치 내역 + 자동 보정 결과 |

### 7.2 이메일 발송 구현 방향
- Spring Boot `JavaMailSender` + Thymeleaf 템플릿 사용.
- 발송 실패 시 **3회 재시도** (1분, 5분, 30분 간격).
- 발송 이력 테이블 (`email_log`) 별도 관리 (향후 추가).

---

## 8. 동시성 및 성능 정책

### 8.1 Redis 캐시 전략
| 대상 | 키 패턴 | TTL | 무효화 시점 |
|------|---------|-----|------------|
| 부서 트리 | `dept:tree` | 10분 | 부서 CUD 시 |
| 메뉴 트리 | `menu:tree` | 30분 | 메뉴 CUD 시 |
| 공통 코드 | `code:{groupCode}` | 1시간 | 코드 CUD 시 |
| 라이센스 잔여수량 | `license:qty:{id}` | 5분 | 배정/회수 시 |
| 자산 현황 요약 | `asset:summary` | 5분 | 자산 CUD 시 |

### 8.2 분산락 정책
- **Redis SETNX** 기반 분산락 사용.
- 락 TTL: 30초 (데드락 방지).
- 락 획득 실패 시: 100ms 간격 최대 3회 재시도.
- 3회 실패 시: `409 Conflict` 응답 ("다른 관리자가 처리 중입니다. 잠시 후 재시도해주세요.").

### 8.3 페이징 정책
- 기본 페이지 크기: 20건.
- 최대 페이지 크기: 100건.
- 정렬 기본값: `reg_date DESC`.
- 목록 조회 시 `is_deleted = false` 기본 조건 적용.

---

## 9. API 에러 코드 정책

| 코드 | HTTP | 설명 |
|------|------|------|
| AUTH_001 | 401 | 인증 실패 (잘못된 아이디/비밀번호) |
| AUTH_002 | 401 | 토큰 만료 |
| AUTH_003 | 403 | 권한 없음 |
| AUTH_004 | 423 | 계정 잠금 (로그인 5회 실패) |
| USER_001 | 409 | 중복 로그인 ID |
| USER_002 | 400 | 잘못된 상태 전이 |
| USER_003 | 400 | 배정 자산/라이센스 존재 (퇴사 처리 시 자동 회수 진행) |
| DEPT_001 | 400 | 하위 부서 존재 (삭제 불가) |
| DEPT_002 | 400 | 소속 사용자 존재 (삭제 불가) |
| DEPT_003 | 400 | 최대 깊이 초과 |
| ASSET_001 | 400 | 잘못된 상태 전이 |
| ASSET_002 | 409 | 이미 배정된 자산 |
| ASSET_003 | 400 | 배정 중인 자산 삭제 불가 |
| ASSET_004 | 409 | 중복 시리얼번호 |
| LICENSE_001 | 400 | 수량 초과 (잔여 수량 부족) |
| LICENSE_002 | 409 | 동일 사용자 중복 배정 |
| LICENSE_003 | 400 | 만료된 라이센스 배정 불가 |
| LICENSE_004 | 400 | 배정 중인 라이센스 삭제 불가 |
| LICENSE_005 | 400 | INDIVIDUAL 유형인데 키 미지정 |
| LICENSE_006 | 409 | 이미 사용 중인 키 |
| COMMON_001 | 409 | 분산락 획득 실패 (동시 처리 충돌) |
| COMMON_002 | 400 | 필수 파라미터 누락 |
| COMMON_003 | 404 | 대상 데이터 없음 |

---

## 10. 감사(Audit) 정책

### 10.1 이력 기록 대상
| 대상 | 기록 항목 | 비고 |
|------|----------|------|
| 자산 배정/반납/이관 | 자산ID, 사용자ID, 액션유형, 일시, 비고 | 영구 보존 |
| 라이센스 배정/회수/변경/만료 | 라이센스ID, 키ID, 사용자ID, 액션유형, 일시, 사유 | 영구 보존 |

### 10.2 이력 테이블 원칙
- **INSERT-ONLY**: 이력 테이블은 수정/삭제가 불가하다.
- 이력 데이터에는 `upd_date`, `upd_id`, `is_deleted`를 포함하지 않는다.
- `reg_date`, `reg_id`만 포함한다.
